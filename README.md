# Laravel Audit Diff

Eloquent モデルの更新差分（before / after）を自動で記録する Laravel
パッケージです。

SaaS や業務システムにおける監査ログ・変更履歴管理を目的としています。

------------------------------------------------------------------------

## 🎯 目的

-   誰が
-   いつ
-   どこで
-   何を変更したか

を、差分付きで永続化します。

コンプライアンス対応、問い合わせ調査、運用ログ用途を想定しています。

------------------------------------------------------------------------

# 🚀 インストール

``` bash
composer require ryoyoshihara/laravel-audit-diff
```

------------------------------------------------------------------------

# ⚙ 初期セットアップ（推奨）

``` bash
php artisan audit-diff:install --migrate
```

このコマンドは：

-   config ファイル publish
-   migration ファイル publish
-   マイグレーション実行（--migrate 指定時）

を自動で行います。

------------------------------------------------------------------------

## install コマンド詳細

### 基本

``` bash
php artisan audit-diff:install
```

-   config 未存在時のみ publish
-   migration 未存在時のみ publish
-   既存ファイルは上書きしません

### マイグレーションまで実行

``` bash
php artisan audit-diff:install --migrate
```

------------------------------------------------------------------------

# 🧪 使用方法

対象モデルに `Auditable` トレイトを追加します。

``` php
use RyoYoshihara\LaravelAuditDiff\Traits\Auditable;

class User extends Model
{
    use Auditable;
}
```

モデル更新時、自動で `audit_logs` テーブルに差分が保存されます。

------------------------------------------------------------------------

# 📊 保存されるデータ

  カラム           説明
  ---------------- --------------------------
  auditable_type   モデルクラス名
  auditable_id     モデルID
  event            updated
  actor_id         変更者ID
  actor_type       変更者モデル
  diff             変更差分
  before           変更前値（変更キーのみ）
  after            変更後値（変更キーのみ）
  url              リクエストURL
  method           HTTPメソッド
  ip               IPアドレス
  user_agent       UserAgent
  created_at       記録日時

------------------------------------------------------------------------

# 🔐 actor（誰が変更したか）

デフォルトでは：

``` php
auth()->user()
```

から取得します。

### カスタム actor を使用する場合

config/audit-diff.php:

``` php
'actor_resolver' => function () {
    return [
        'id' => session('admin_login.id'),
        'type' => \App\Models\AdminUser::class,
    ];
},
```

------------------------------------------------------------------------

# 🛡 マスキング

以下のキーは自動で `***` に置換されます。

``` php
'mask_keys' => [
    'password',
    'token',
    'secret',
    'api_key',
],
```

ネストした配列も再帰的にマスクされます。

------------------------------------------------------------------------

# 🔄 差分仕様

diff は以下形式で保存されます。

``` json
{
  "name": { "before": "A", "after": "B" }
}
```

------------------------------------------------------------------------

# ⚖ null と空文字の扱い

デフォルトでは：

``` php
'null_equals_empty_string' => true
```

空文字と null を同一視します。

------------------------------------------------------------------------

# 🚫 updated_at のみ変更された場合

``` php
'skip_if_only_timestamps_changed' => true
```

の場合、ログは記録されません。

------------------------------------------------------------------------

# 🧩 設計思想

-   最小設定で動作
-   導入は1コマンド
-   差分のみ保存（デフォルト）
-   認証方式に依存しない設計
-   セキュリティ配慮（mask_keys）

------------------------------------------------------------------------

# 📌 v0.1 制限事項

-   updated イベントのみ対応
-   created / deleted は今後対応予定
-   大量バルク更新には未対応

------------------------------------------------------------------------

# 🔮 今後の拡張予定

-   created / deleted 対応
-   モデルごとの除外フィールド指定
-   UI提供
-   非同期保存（Queue）
-   Packagist 公開

------------------------------------------------------------------------

# License

MIT
